<h1 align="center">Block Data Verification</h1>

## Light Client Verification

Poly provides a solution based on block header synchronization like the Simple Payment Verification (SPV) protocol in Bitcoin and  Light Ethereum Subprotocol (LES) in Ethereum

- Synchronize an initial block header of the side chain to the poly chain for initializing, and then synchronize all the subsequent blocks of the side chain to the poly chain.
- Verify the block header based on the critical blockchain data such as mining difficulties and signature with validator set. 
- Verify cross-chain transaction using Merkle state root hash in block header and Merkle proof generated by source chain.

## Check List

It is crucial to know whether a chain can join poly using Light Client Verification, and the block header must contain the following informationï¼š

- The hash of the previous block header
- Merkle state root hash
- The necessary information to prove the legitimacy of the block header varies from different consensus mechanisms.

> [!NOTE]
> Please get in touch with the poly team for more support if your chain doesn't support techniques like Simple Payment Verification (SPV) protocol in Bitcoin or  Light Ethereum Subprotocol (LES) in Ethereum.


## Essential Chain Elements

Some features and attributes need to be clarified for joining the cross-chain ecosystem. These features are the critical elements for implementing the interface method for handling block headers and cross-chain events.

#### Consensus Algorithm

The Consensus Algorithm determines how blockchains select consensus validators,  voters, and block producers for minting new blocks and bookkeeping block transactions. Developers need to clearly understand the consensus protocol of the blockchain to get sufficient information for validating block headers.

For instance, for blockchains that use POS, one of the essential elements for verifying blocks are signatures from validator nodes, which requires the developers Know the consensus nodes' election process, and who are the consensus nodes in the next epoch.

#### Initial Block of the Chain

The initial block, usually the canonical block, whose block header needs to be submitted to the relay chain of the cross-chain ecosystem to verify the consequent block headers and transactions.

#### Block Header Structure and Verification Methods

The block header verification and processing method together with **block header format**, the **serialization**, and the **deserialization methods** are necessary for implementing the interface method of header sync solution

#### Merkle Tree Structure, Generation and Verification Methods

The Merkle tree structure, generation, and verification methods for the ledger records or transactions are necessary to verify cross-chain transactions.  Given the trusted block header, its application **state root** can help confirm the validity of **transaction proof** and obtain the actual cross-chain transaction message. 

By having a Merkle proof and the correct block header, we can prove that a particular transaction or event occurred on the chain with certainty.

## Development Specifications

This chapter shows developers how to cooperate with the poly network team to add a chain into the poly cross-chain ecosystem. Mainly for **Header Sync** because the **Consensus Vote** hardly needs any additional targeted development.The methods that developers need to implement:

- Block Header Synchronization Method, including header sync functions and their corresponding entrance functions.
- Handler for handling the cross-chain transaction with Merkle proof.

### Block Header Synchronization

To implement cross-chain features for any chain, say Ethereum, there are two kinds of contracts that need to be deployed-

Block header synchronization contract: This contract maintains the record of block headers of the relay chain on this chain. These block headers serve as means to verify cross-chain transactions.

The interface methods that need to be implemented by the respective contracts are as follows:

#### Block Header Synchronization Method

| Method                | Description                                                  |
| --------------------- | ------------------------------------------------------------ |
| **SyncGenesisHeader** | Synchronizes the side chain's genesis block header (or canonical block header that has sufficient information to verify subsequent block headers) to the relay chain. The method is called one time only when initializing the side chain. It stores and handles the initial block header so that the subsequent block headers of blocks that contain cross-chain events can be verified and synchronized; please refer to the [code](https://github.com/polynetwork/poly/blob/master/native/service/header_sync/eth/header_sync.go#L61) for more details. |
| **SyncBlockHeader**   | Consistently synchronizes block cycle change and cross-chain transaction block headers from the side chain to the relay chain; the relayers use this interface method to synchronize block headers, stores, and process block headers, fetches the consensus node info if block generation cycle changes; please refer to the [code](https://github.com/polynetwork/poly/blob/master/native/service/header_sync/eth/header_sync.go#L99) for more details. |


#### Block Header Synchronization Entrance Method

| Method                         | Description                                                  |
| ------------------------------ | ------------------------------------------------------------ |
| **SyncSideChainGenesisHeader** | It is the entrance method for synchronizing the genesis block header of the side chain to poly chain and synchronizing the genesis header of the poly chain to ccm contract of the side chain; please refer to the [code](https://github.com/polynetwork/poly-io-test/blob/master/cmd/tools/run.go#L607) for more details. |

The Key information for this method(submitted by .config):

- Service provider(endpoint) Url of side chain

- Selected genesis block height

- Essential information for verifying genesis headers may exist in header information already or need to be fetched from block headers from other block height

- Information required for the side chain block header verification


### Cross-Chain Management

Cross-chain management contract: Every chain can have no more than one management contract. It creates cross-chain transactions that are transferred to the relay chain. All the service contracts that contain the business logic need to communicate with the management contract.

The interface methods that need to be implemented by the respective contracts are as follows:

#### Cross Chain Management

| Method                  | Description                                                  |
| ----------------------- | :----------------------------------------------------------- |
| **MakeDepositProposal** | Creates cross-chain transactions invoked by service contracts. When a cross-chain function is carried out in the logic, a transaction includes a unique chain ID; the transaction is recorded in the Merkle tree. Act as the entrance of verifyFromTx, verifying, storing, and returning MakeTxParam for processing cross-chain steps. Please refer to the [code](https://github.com/polynetwork/poly/blob/master/native/service/cross_chain_manager/eth/eth_handler.go#L34) for details. |

```go
MakeDepositProposal:
Requires:
service *native.NativeService   //Native Service that carries values of information of cross-chain events
Returns:
type verifyFromTx struct {
	TxHash              []byte    
	CrossChainId        []byte    //ChainId of source chain
	FromContractAddress uint64    //Cross Chain Management Contarct address of source chain
	ToChainId           string    //ChainId of target chain
	ToContractAddress   uint64    //Cross Chain Management Contarct address of target chain
	Method              []byte    //Unlock or lock
	Args                []byte
}
```
| Method           | Description                                                  |
| ---------------- | :----------------------------------------------------------- |
| **verifyFromTx** | Prepare block header and deserialized proof for verifyMerkleProof, decode the extra data from tx and construct MakeTxParam. Please refer to the [code](https://github.com/polynetwork/poly/blob/4323af5cfcd2a3277653d5bdc4db015cd9755fee/native/service/cross_chain_manager/eth/utils.go#L41) for details. |

```go
verifyFromTx:
Requires:
service               *native.NativeService  
proof                 []byte    //the proof to be serialized and verified
extra                 []byte    //the transaction information that will be used for constructing verifyFromTx
fromChainID           uint64,   //ChainId of source chain
height                uint32,   //the block height corresponding to current transaction event
sideChain             *side_chain_manager.SideChain //source chain information that contains ccm contract address
Returns:
txParam               *scom.MakeTxParam 
```
| Method                | Description                                                  |
| --------------------- | :----------------------------------------------------------- |
| **verifyMerkleProof** | Verify the Merkle proof obtained by the relayer generated from the source chain to ensure that all transactions included in this block header have been created and have occurred on the relay chain. Please refer to the [code](https://github.com/polynetwork/poly/blob/4323af5cfcd2a3277653d5bdc4db015cd9755fee/native/service/cross_chain_manager/eth/utils.go#L88) for details. |

```go
verifyMerkleProof:
Requires:
blockData             *types.Header //the blockheader corresponding to current transaction event  
proof                 []byte    //the serialized proof
Returns:
Val                   []byte    //the proof result for checking extra before constructing verifyFromTx
```
